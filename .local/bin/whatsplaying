#!/usr/bin/env zsh

__ScriptVersion="0.1.0"

#===  FUNCTION  ================================================================
#         NAME:  usage
#  DESCRIPTION:  Display usage information.
#===============================================================================
function usage ()
{
	echo "Usage :  $0 [options] [--]

    Options:
    -n|notify     Flag to send notification
    -s|signal     Flag waybar to update display
    -h|help       Display this message
    -v|version    Display script version"

}    # ----------  end of function usage  ----------

notify=0

#-----------------------------------------------------------------------
#  Handle command line arguments
#-----------------------------------------------------------------------

while getopts ":hvsn" opt
do
  case $opt in

	h|help     )  usage; exit 0   ;;

	v|version  )  echo "$0 -- Version $__ScriptVersion"; exit 0   ;;

	n|notify   ) notify=1 ;;

	s|signal   ) pkill -RTMIN+3 waybar ;;

	* )  echo -e "\n  Option does not exist : $OPTARG\n"
		  usage; exit 1   ;;

  esac    # --- end of case ---
done
shift $(($OPTIND-1))

format='{{title}} | {{artist}}'
trackinfo=$(timeout 2 playerctl metadata -f "$format")
exitinfo=$?
if [[ $exitinfo == 0 ]]; then
  echo $trackinfo
  if [[ $notify == 1 ]]; then
    artist=$(echo $trackinfo | cut -d'|' -f2 | sed 's/^\s//g')
    song=$(echo $trackinfo | cut -d'|' -f1 | sed 's/\s\$//g')
    icon=$(timeout 2 playerctl metadata mpris:artUrl)
    if [[ $? == 0 ]]; then
      curl $icon > /tmp/playing.png
      notify-send -i /tmp/playing.png "$artist" "$song"
    else
      notify-send -i audio-headphones "$artist" "$song"
    fi
  fi
fi
exit $exitinfo
